<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시판</title>
    <style>
        p {
            padding: 0px;
            margin: 0px;
            margin-top: 5px;
        }
        body {
            margin: auto;
            text-align: center;
        }
        #username {
            width: 80px;
        }
        #textarea {
            width: 250px;
        }
        #textbox {
            margin: auto;
            margin-top: 20px;
            text-align: center;
            border-collapse: collapse;
        }
        #t_number {
            width: 50px;
        }
        #t_user {
            width: 80px;
        }
        #t_content {
            width: 400px;
        }
        #t_date {
            width: 190px;
        }
        .btn {
            margin-top: 20px;
            margin-left: 540px;
        }
    </style>
</head>
<body>
    <h2>게시판</h2>
    <input type="text" id="username">
    <input type="text" id="textarea">
    <button id="push">글작성</button>
    <br>
    <div class="btn">
    <button id="savebtn" onclick="downloadText()">저장하기</button>
    <button for="fileBtn" class="function-btn" id="open_file">불러오기</button>
    <input type="file" id="fileBtn" style="display:none" accept=".json" title='Select JSON File' />
    <button id="resetbtn">게시판 비우기</button>
    </div>
    <table id="textbox" border="1px">
        <tr>
            <th id="t_number">번호</th>
            <th id="t_user">작성자</th>
            <th id="t_content">내용</th>
            <th id="t_date">작성일</th>
            <th id="t_skill">기능</th>
        </tr>
    </table>
    <script>
        //글 저장할 객체 배열 생성 여기에 글이 저장됨
        let posts = [];
        // 엔터누르면올라감
        document.addEventListener('keypress', function(event) {
            // 엔터키 코드->13번
            if (event.keyCode === 13) {
                // 포커스가 이름이나 내용쪽일때만 작동
                if (document.activeElement.id === 'username' || document.activeElement.id === 'textarea') {
                    
                    let username = document.querySelector('#username').value;
                    let textarea = document.querySelector('#textarea').value;
                    
                    // 내용비엇는지확인
                    if (textarea.trim() === '') {
                        alert('내용을 입력하세요.'); // 내용비면경고창
                        return; // 함수중지
                    }
                    
                    //푸쉬랑 같은 효과를 내기 위해 호출
                    document.querySelector('#push').click();
                }
            }
        });
        //버튼에 이벤트 추가.. 버튼을 클릭했을 때 밑에 있는 것들이 실행됨
        document.querySelector('#push').addEventListener('click', function (){
            //사용자가 입력한 이름의 값을 가져옴
            let username = document.querySelector('#username').value;
            //사용자가 입력한 글의 값을 가져옴
            let textarea = document.querySelector('#textarea').value;
            
            if (textarea.trim() === '') {
                alert('내용을 입력하세요.'); //내용이 비었는지 확인
                return;
            }
            //Date()는 현재 시간과 날짜 정보를 제공하는 객체임
            //매개변수 입력x일 때 현재 시간과 날짜 가리키는 객체를 생성함
            let nowtime = new Date();
            
    
            //toLocaleString()은 시간과 날짜 객체의 내용을 해당 지역에 맞는 문자열로 변환해주는 메소드임
            //현재 날짜와 시간을 한국에 맞는 문자열로 변환해줌
            let nowtime_str = nowtime.toLocaleString();
            
    
            //새로운 글 객체를 생성.. 글번호,작성자,글내용,작성일을 포함하고 있음
            let post = {
                //배열의 인덱스는 0부터 시작하므로,.. 새로운 글이 추가될 때마다
                //글 번호가 1씩 증가할 수 있도록 posts.length+1을 사용
                number: posts.length + 1,
                user: username,
                content: textarea,
                date: nowtime_str
            };
    
            //새로 작성된 글 객체(post)를 posts 배열에 추가함
            posts.push(post);
    
            //테이블 값 가져오기
            let table = document.querySelector('#textbox');
            
            //insertRow()는 테이블의 마지막에 새로운 행을 추가해주는 메소드임
            //insertRow(0)은 테이블 첫 번째 위치에, insertRow(-1)은 테이블 마지막 위치에 새로운 행 추가
            let row = table.insertRow(-1);
    
            //insertCell()은 새로운 셀을 추가하고 해당 셀에 대한 참조를 반환하는 메소드
            //특정 위치에 새로운 셀 삽입 가능
            //insertCell(0)은 행의 첫 번째 위치에, insertCell(-1)은 마지막에 새로운 셀을 추가
            let number_cell = row.insertCell(0);
            let user_cell = row.insertCell(1);
            let content_cell = row.insertCell(2);
            let time_cell = row.insertCell(3);
            let skill_cell = row.insertCell(4);
    
            //셀에 각자 맞는 객체 삽입
            number_cell.innerHTML = post.number;
            user_cell.innerHTML = post.user;
            content_cell.innerHTML = post.content;
            time_cell.innerHTML = post.date;
    
            //삭제 버튼 생성
            let xbtn = document.createElement('button');
            //버튼 내에 글씨 추가
            xbtn.textContent = '삭제';
            //기능 추가하는 부분
            xbtn.addEventListener('click', function() {
                //confirm vs alert
                //alert은 확인 버튼만 있지만 confirm은 확인 및 취소 버튼이 있음
                if (confirm('정말 삭제하시겠습니까?')) {
                    // 삭제할 행의 인덱스를 찾아서 해당 행 삭제
                    let rowIndex = row.rowIndex;
                    table.deleteRow(rowIndex);
                    // 삭제된 글을 배열에서도 삭제
                    posts.splice(rowIndex - 1, 1);
                }
            });

            //댓글 버튼 생성
            let commentbtn = document.createElement('button');
            //버튼 내에 글씨 추가
            commentbtn.textContent = '댓글';
            //기능 추가하는 부분
            commentbtn.addEventListener('click', function() {
                //prompt창으로 댓글을 입력 받음
                let comment = prompt('댓글을 입력하세요');
                if (comment !== null) { // 취소 버튼이 아닌 경우에만 처리
                    //댓글을 담을 p요소를 만들어
                    let pcomment = document.createElement('p');
                    let comment_time = new Date().toLocaleString();
                    //만든 p요소에 입력받았던 댓글을 넣고
                    pcomment.textContent = "▶"+comment +" "+"("+comment_time+")";
                    //내용셀에 추가
                    content_cell.appendChild(pcomment);
                    
                }
            });

            resetbtn.addEventListener('click', function() {
                //테이블 변수 생성<<여기에 테이블값가져옴
                let table = document.querySelector('#textbox');
                //테이블 행 개수를 변수에 담음
                let rowcount = table.rows.length;
                //조건식
                if (rowcount > 1) {
                    //첫번째행은 지우면 안 되니까 행개수-1을 해야 됨
                    //첫번째 행 제외 삭제 
                    for (let i = rowcount-1; i>0; i--) {
                        table.deleteRow(i);
                    }
                }
                
            });
            
            //버튼 삽입할 공간 만들기
            let skillbtn = document.createElement('div');
            //공간에 버튼들 넣음
            skillbtn.appendChild(xbtn);
            skillbtn.appendChild(commentbtn);
            //만든 공간을 셀에 추가
            skill_cell.appendChild(skillbtn);

            //push버튼 누르면 입력창 초기화
            document.querySelector('#username').value = '';
            document.querySelector('#textarea').value = '';
        });
        
        function downloadText(filename) {
            if (posts.length == 0) {
            alert('저장할 데이터가 없습니다.');
            return;
            }
            var element = document.createElement('a');
            var jsonString = JSON.stringify(posts, null, 4);
            element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(jsonString));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            }
        

        const label = document.getElementById('open_file');
        const fileInput = document.getElementById('fileBtn');

        label.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fr = new FileReader();
            fr.onload = () => {
                var fileContent = fr.result;
                var jsonObj = JSON.parse(fileContent);
            }
            fr.readAsText(file);
        });
    </script>
    
</body>
</html>