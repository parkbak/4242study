<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>초간단게시판</title>
    <style>
        .input-text-label {
            font-weight: bold;
            min-width: 100px;
        }

        input[type="number"],
        input[type="text"] {
            height: 38px;
            line-height: 38px;
            padding: 5px;
            border-radius: 3px;
            box-shadow: 0 0 3px rgba(40, 40, 40, 0.2);
            border: none;
            font-size: 14px;
        }

        .normal-btn,
        .function-btn {
            font-size: 14px;
            height: 38px;
        }

        .normal-btn {
            width: 100px;
        }

        .function-btn {
            width: 200px;
            border-radius: 3px;
            border: 1px solid #0887f0;
            background: #d8eef7;
        }

        table {
            width: 100%;
            border: 1px solid #444444;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #444444;
            text-align: center;
        }
    </style>
</head>

<body>
    <input type="text" id="user" placeholder="이름 입력" />
    <input type="text" id="textcontent" placeholder="내용 입력" />
    <button id="add_text" class="normal-btn">글작성</button>
    <br><br><br>

    <!-- 기능 패널 -->
    <div style="float: right;">
        <button id="download_text" class="function-btn">저장하기</button>
        <button id="open_file" class="function-btn">불러오기</button>
        <input type="file" id="fileBtn" style="display:none" accept=".json" />
        <button id="clearall_text" class="function-btn">게시판비우기</button>
    </div>
    <br>

    <!-- 검색 패널 -->
    <div style="float: left;">
        <input type="text" id="text_find" placeholder="검색어 입력" />
        <button id="findtextBtn" class="normal-btn">검색</button>
        <button id="viewallBtn" class="normal-btn">검색해제</button>
    </div>
    <br>

    <div id="textlist">
        <table>
            <tr>
                <th style="width: 20px;">번호</th>
                <th style="width: 60px;">작성자</th>
                <th style="width: 300px;" id="text">내용</th>
                <th style="width: 100px;">작성일</th>
                <th style="width: 100px;">기능</th>
            </tr>
        </table>
    </div>
    <div id="pagination" style="text-align: center; margin-top: 20px;"></div>

    <script>
        // 데이터 저장
        let contents = JSON.parse(localStorage.getItem('contents')) || [];
        let searchResults = [];
        let itemsPerPage = 5;
        let currentPage = 1;
    
        // DOM 요소 캐싱
        const user = document.getElementById('user');
        const content = document.getElementById('textcontent');
        const textlist = document.getElementById('textlist');
        const fileInput = document.getElementById('fileBtn');
        const text_find = document.getElementById('text_find');
        const pagination = document.getElementById('pagination');
    
        // 이벤트 핸들러 등록
        document.getElementById('add_text').addEventListener('click', addText);
        document.getElementById('download_text').addEventListener('click', () => downloadText('contents.json'));
        document.getElementById('open_file').addEventListener('click', () => fileInput.click());
        document.getElementById('clearall_text').addEventListener('click', clearAll);
        document.getElementById('findtextBtn').addEventListener('click', findText);
        document.getElementById('viewallBtn').addEventListener('click', viewAll);
        document.getElementById('text').addEventListener('dbclick', textclick)
    
        fileInput.addEventListener('change', handleFileSelect);
        user.addEventListener('keydown', handleKeyPress);
        content.addEventListener('keydown', handleKeyPress);
    
        function handleKeyPress(e) {
            if (e.keyCode === 13) {
                e.target.id === 'user' ? content.focus() : addText();
            }
        }
    
        function handleFileSelect(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                contents = JSON.parse(reader.result);
                saveToLocalStorage();
                refreshList();
            };
            reader.readAsText(file);
        }
    
        function findText() {
            const searchTerm = text_find.value.trim();
            if (searchTerm === '') {
                alert('검색어를 입력해주세요.');
                return;
            }
    
            searchResults = contents.filter(item =>
                item.content.includes(searchTerm) || item.comment.some(comment => comment.includes(searchTerm))
            );
    
            currentPage = 1;
            refreshList();
        }
    
        function viewAll() {
            searchResults = [];
            text_find.value = '';
            currentPage = 1;
            refreshList();
        }
    
        function addText() {
            contents.push({
                id: user.value,
                content: content.value,
                date: new Date().toLocaleString(),
                comment: []
            });
    
            saveToLocalStorage();
            refreshList();
        }
    
        function clearAll() {
            if (confirm('정말 삭제하시겠습니까?')) {
                contents = [];
                saveToLocalStorage();
                refreshList();
            }
        }

        function textclick() {
            
        }
    
        function refreshList() {
            const list = searchResults.length ? searchResults : contents;
            const page = currentPage;
            const paginatedList = list.slice((page - 1) * itemsPerPage, page * itemsPerPage);
    
            let htmlText = `
                <table>
                    <tr>
                        <th style="width: 20px;">번호</th>
                        <th style="width: 60px;">작성자</th>
                        <th style="width: 300px;">내용</th>
                        <th style="width: 100px;">작성일</th>
                        <th style="width: 100px;">기능</th>
                    </tr>`;
    
            paginatedList.forEach((item, index) => {
                htmlText += `
                    <tr>
                        <td>${(page - 1) * itemsPerPage + index + 1}</td>
                        <td>${item.id}</td>
                        <td style="text-align: left;">${item.content}${item.comment.length ? '<br>' + item.comment.map(comment => `⌊ ${comment}`).join('<br>') : ''}</td>
                        <td>${item.date}</td>
                        <td>
                            <button class='function-btn' style="width: 60px;" onclick="deleteText(${index}, ${searchResults.length ? 'true' : 'false'})">삭제</button>
                            <button class='function-btn' style="width: 60px;" onclick="addComment(${index}, ${searchResults.length ? 'true' : 'false'})">댓글</button>
                        </td>
                    </tr>`;
            });
    
            textlist.innerHTML = htmlText + '</table>';
            renderPagination(list.length, page);
            user.value = '';
            content.value = '';
        }
    
        function renderPagination(totalItems, page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            let paginationHtml = '';
    
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<button onclick="goToPage(${i})" class="normal-btn" ${i === page ? 'style="font-weight:bold;"' : ''}>${i}</button>`;
            }
    
            pagination.innerHTML = paginationHtml;
        }
    
        function goToPage(page) {
            currentPage = page;
            refreshList();
        }
    
        function deleteText(index, isSearch) {
            if (confirm('정말 삭제하시겠습니까?')) {
                const list = isSearch ? searchResults : contents;
                const originalIndex = contents.indexOf(list[index]);
                contents.splice(originalIndex, 1);
                if (isSearch) {
                    searchResults.splice(index, 1);
                }
                saveToLocalStorage();
                refreshList();
            }
        }
    
        function addComment(index, isSearch) {
            const comment = prompt('댓글을 입력하세요');
            if (comment) {
                const list = isSearch ? searchResults : contents;
                const originalIndex = contents.indexOf(list[index]);
                contents[originalIndex].comment.push(`${comment} (${new Date().toLocaleString()})`);
                saveToLocalStorage();
                refreshList();
            }
        }
    
        function downloadText(filename) {
            if (contents.length === 0) {
                alert('저장할 데이터가 없습니다.');
                return;
            }
    
            const element = document.createElement('a');
            const jsonString = JSON.stringify(contents, null, 4);
    
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(jsonString));
            element.setAttribute('download', filename);
    
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    
        function saveToLocalStorage() {
            localStorage.setItem('contents', JSON.stringify(contents));
        }

    
        // 초기화
        refreshList();
    </script>
    
</body>
</html>